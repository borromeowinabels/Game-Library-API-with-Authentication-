var express = require('express'),
    formidable = require('formidable'),
    conf = require('./app.json'),
    find = require('fs2json');


var app = express();
var rootDir = conf.downloadFrom;
var uploadDir = conf.uploadTo;



app.use('/', express.static(__dirname + '/public'));

app.get('/path', function (req, res) {
  var path = req.query.path;
  if (!path) {
    return res.send(400);
  }
  var _finder = find();
  _finder.traverse({path: [rootDir, path].join('/'), depth:1}, function (err, data) {
    if (err)  { res.send(404); }
    else      { res.json(data); }
  });
});

app.post('/upload', function (req, res, next) {
  var form = new formidable.IncomingForm();
  form.uploadDir = uploadDir;
  form.parse(req, function (err, fields, files) {
    res.send(200);
  });
});

app.get('/download', function (req, res, next) {
  var path = req.query.path;
  if (!path) {
    return res.send(400);
  }
  var fullPath = require('path').resolve([rootDir, path].join('/'));
  require('fs').exists(fullPath, function (exists) {
    if (!exists) {
      return res.send(404);
    }
    res.download(fullPath);
    console.log(fullPath);
  });
});

app.listen(8000);
